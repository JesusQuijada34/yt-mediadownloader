#!/bin/bash
# =============================================================================
# YouTube Media Downloader - Script de EjecuciÃ³n AutomÃ¡tica para Unix/Linux/macOS
# =============================================================================
#
# Este script automatiza la instalaciÃ³n y ejecuciÃ³n de la aplicaciÃ³n
# YouTube Media Downloader en sistemas Unix/Linux/macOS.
#
# Autor: influent
# VersiÃ³n: 1.0.0
# Fecha: 2024-12-19
# Licencia: MIT
#
# =============================================================================
# INSTRUCCIONES PARA PRINCIPIANTES
# =============================================================================
#
# 1. PERMISOS: Dale permisos de ejecuciÃ³n al script:
#    chmod +x autorun
#
# 2. EJECUTAR: Ejecuta el script desde la terminal:
#    ./autorun
#
# 3. PERMISOS: Si se te pide contraseÃ±a, es normal para instalar paquetes
# 4. ESPERAR: El script instalarÃ¡ las dependencias automÃ¡ticamente
# 5. DISFRUTAR: La aplicaciÃ³n se abrirÃ¡ automÃ¡ticamente
#
# =============================================================================
# REQUISITOS DEL SISTEMA
# =============================================================================
#
# - Linux (Ubuntu 18.04+, Debian 10+, CentOS 8+, etc.)
# - macOS 10.14+ (Mojave o superior)
# - Python 3.7 o superior instalado
# - ConexiÃ³n a Internet para descargar dependencias
# - Permisos de sudo (para instalaciÃ³n de paquetes del sistema)
#
# =============================================================================
# FUNCIONES DEL SCRIPT
# =============================================================================
#
# âœ“ DetecciÃ³n automÃ¡tica del sistema operativo
# âœ“ VerificaciÃ³n de Python instalado
# âœ“ InstalaciÃ³n automÃ¡tica de dependencias del sistema
# âœ“ ConfiguraciÃ³n del entorno virtual (opcional)
# âœ“ InstalaciÃ³n de dependencias de Python
# âœ“ EjecuciÃ³n de la aplicaciÃ³n
# âœ“ Manejo de errores y notificaciones
# âœ“ Limpieza automÃ¡tica de archivos temporales
#
# =============================================================================

# Colores para la salida
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# FunciÃ³n para imprimir mensajes con colores
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${PURPLE}$1${NC}"
}

# FunciÃ³n para limpiar al salir
cleanup() {
    print_status "Limpiando archivos temporales..."
    rm -rf __pycache__ 2>/dev/null
    rm -f *.pyc 2>/dev/null
    print_success "Limpieza completada"
}

# Configurar trap para limpieza al salir
trap cleanup EXIT

# =============================================================================
# ENCABEZADO Y VERIFICACIONES INICIALES
# =============================================================================

clear
echo
print_header "============================================================================="
print_header "ğŸ¬ YOUTUBE MEDIA DOWNLOADER - INSTALADOR AUTOMÃTICO"
print_header "============================================================================="
echo
print_status "ğŸš€ Iniciando proceso de instalaciÃ³n automÃ¡tica..."
print_status "ğŸ“… Fecha y hora: $(date)"
print_status "ğŸ’» Sistema operativo: $(uname -s)"
print_status "ğŸ” DistribuciÃ³n: $(lsb_release -d 2>/dev/null | cut -f2 || echo 'No disponible')"
print_status "ğŸ—ï¸ Arquitectura: $(uname -m)"
echo

# =============================================================================
# DETECCIÃ“N DEL SISTEMA OPERATIVO
# =============================================================================

print_status "ğŸ” Detectando sistema operativo..."

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    if command -v apt-get &> /dev/null; then
        OS="debian"
        PKG_MANAGER="apt-get"
        print_success "Sistema Debian/Ubuntu detectado (apt-get)"
    elif command -v yum &> /dev/null; then
        OS="redhat"
        PKG_MANAGER="yum"
        print_success "Sistema RedHat/CentOS detectado (yum)"
    elif command -v pacman &> /dev/null; then
        OS="arch"
        PKG_MANAGER="pacman"
        print_success "Sistema Arch Linux detectado (pacman)"
    else
        print_warning "Sistema Linux detectado pero gestor de paquetes no reconocido"
        OS="linux"
        PKG_MANAGER="unknown"
    fi
elif [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    OS="macos"
    PKG_MANAGER="brew"
    print_success "Sistema macOS detectado (Homebrew)"
else
    print_warning "Sistema operativo no reconocido: $OSTYPE"
    OS="unknown"
    PKG_MANAGER="unknown"
fi

# =============================================================================
# VERIFICACIÃ“N DE PYTHON
# =============================================================================

print_status "ğŸ” Verificando instalaciÃ³n de Python..."

# Verificar si Python estÃ¡ instalado
if ! command -v python3 &> /dev/null; then
    print_error "Python3 no estÃ¡ instalado o no estÃ¡ en el PATH del sistema"
    echo
    print_status "ğŸ“‹ SOLUCIÃ“N: Instala Python desde tu gestor de paquetes:"
    
    case $OS in
        "debian")
            echo "   sudo apt update && sudo apt install python3 python3-pip"
            ;;
        "redhat")
            echo "   sudo yum install python3 python3-pip"
            ;;
        "arch")
            echo "   sudo pacman -S python python-pip"
            ;;
        "macos")
            echo "   brew install python"
            ;;
        *)
            echo "   Visita https://www.python.org/downloads/"
            ;;
    esac
    echo
    print_status "ğŸ”„ DespuÃ©s de instalar Python, ejecuta este script nuevamente"
    echo
    exit 1
fi

# Obtener versiÃ³n de Python
PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
print_success "Python $PYTHON_VERSION detectado correctamente"

# Verificar versiÃ³n mÃ­nima (Python 3.7+)
PYTHON_MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
PYTHON_MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)

if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 7 ]); then
    print_error "Se requiere Python 3.7 o superior"
    print_status "VersiÃ³n actual: $PYTHON_VERSION"
    exit 1
fi

print_success "VersiÃ³n de Python compatible ($PYTHON_VERSION)"

# =============================================================================
# VERIFICACIÃ“N DE PIP
# =============================================================================

echo
print_status "ğŸ” Verificando instalaciÃ³n de pip..."

if ! command -v pip3 &> /dev/null; then
    print_error "pip3 no estÃ¡ disponible"
    echo
    print_status "ğŸ“‹ SOLUCIÃ“N: Instala pip3:"
    
    case $OS in
        "debian")
            echo "   sudo apt install python3-pip"
            ;;
        "redhat")
            echo "   sudo yum install python3-pip"
            ;;
        "arch")
            echo "   sudo pacman -S python-pip"
            ;;
        "macos")
            echo "   brew install python"
            ;;
    esac
    echo
    exit 1
fi

PIP_VERSION=$(pip3 --version 2>&1 | awk '{print $2}')
print_success "pip $PIP_VERSION disponible"

# =============================================================================
# ACTUALIZACIÃ“N DE PIP
# =============================================================================

echo
print_status "ğŸ”„ Actualizando pip a la Ãºltima versiÃ³n..."
if pip3 install --upgrade pip --quiet; then
    print_success "pip actualizado correctamente"
else
    print_warning "No se pudo actualizar pip, continuando..."
fi

# =============================================================================
# INSTALACIÃ“N DE DEPENDENCIAS DEL SISTEMA
# =============================================================================

echo
print_status "ğŸ“¦ Instalando dependencias del sistema..."

case $OS in
    "debian")
        print_status "Instalando paquetes del sistema para PyQt5..."
        sudo apt update
        sudo apt install -y python3-pyqt5 python3-pyqt5.qtwebengine python3-dev build-essential
        ;;
    "redhat")
        print_status "Instalando paquetes del sistema para PyQt5..."
        sudo yum install -y python3-pyqt5 python3-pyqt5-qtwebengine python3-devel gcc
        ;;
    "arch")
        print_status "Instalando paquetes del sistema para PyQt5..."
        sudo pacman -S --noconfirm python-pyqt5 python-pyqtwebengine base-devel
        ;;
    "macos")
        print_status "Verificando Homebrew..."
        if ! command -v brew &> /dev/null; then
            print_status "Instalando Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        print_status "Instalando dependencias con Homebrew..."
        brew install qt5
        ;;
    *)
        print_warning "No se pueden instalar dependencias del sistema automÃ¡ticamente"
        print_status "Instala manualmente PyQt5 y PyQtWebEngine para tu distribuciÃ³n"
        ;;
esac

# =============================================================================
# VERIFICACIÃ“N DE ARCHIVOS DEL PROYECTO
# =============================================================================

echo
print_status "ğŸ” Verificando archivos del proyecto..."

if [ ! -f "yt-mediadownloader.py" ]; then
    print_error "No se encontrÃ³ el archivo principal yt-mediadownloader.py"
    print_status "ğŸ“ AsegÃºrate de ejecutar este script desde la carpeta del proyecto"
    echo
    exit 1
fi

if [ ! -f "lib/requirements.txt" ]; then
    print_error "No se encontrÃ³ lib/requirements.txt"
    print_status "ğŸ“ Verifica que la estructura del proyecto estÃ© completa"
    echo
    exit 1
fi

print_success "Archivos del proyecto verificados correctamente"

# =============================================================================
# INSTALACIÃ“N DE DEPENDENCIAS DE PYTHON
# =============================================================================

echo
print_status "ğŸ“¦ Instalando dependencias de Python..."
print_status "ğŸ” Dependencias a instalar:"
echo "   - PyQt5 (interfaz grÃ¡fica)"
echo "   - PyQtWebEngine (navegador web)"
echo "   - pytube (descarga de YouTube)"
echo

# Instalar dependencias principales
print_status "ğŸ”§ Instalando PyQt5..."
if pip3 install PyQt5 --quiet; then
    print_success "PyQt5 instalado correctamente"
else
    print_error "No se pudo instalar PyQt5"
    print_status "ğŸ’¡ Intenta ejecutar como administrador o verifica tu conexiÃ³n a Internet"
    exit 1
fi

print_status "ğŸ”§ Instalando PyQtWebEngine..."
if pip3 install PyQtWebEngine --quiet; then
    print_success "PyQtWebEngine instalado correctamente"
else
    print_error "No se pudo instalar PyQtWebEngine"
    print_status "ğŸ’¡ Verifica que las dependencias del sistema estÃ©n instaladas"
    exit 1
fi

print_status "ğŸ”§ Instalando pytube..."
if pip3 install pytube --quiet; then
    print_success "pytube instalado correctamente"
else
    print_error "No se pudo instalar pytube"
    exit 1
fi

print_success "Todas las dependencias instaladas correctamente"

# =============================================================================
# VERIFICACIÃ“N DE INSTALACIÃ“N
# =============================================================================

echo
print_status "ğŸ” Verificando instalaciÃ³n de dependencias..."
if python3 -c "import PyQt5; import PyQt5.QtWebEngineWidgets; import pytube; print('âœ… VerificaciÃ³n exitosa')" 2>/dev/null; then
    print_success "VerificaciÃ³n de dependencias completada"
else
    print_error "Las dependencias no se instalaron correctamente"
    print_status "ğŸ”„ Intenta ejecutar: pip3 install -r lib/requirements.txt"
    exit 1
fi

# =============================================================================
# EJECUCIÃ“N DE LA APLICACIÃ“N
# =============================================================================

echo
print_status "ğŸš€ Iniciando YouTube Media Downloader..."
echo
print_status "ğŸ“‹ INFORMACIÃ“N DE LA APLICACIÃ“N:"
echo "   - Nombre: YouTube Media Downloader"
echo "   - VersiÃ³n: 1.0.0"
echo "   - Desarrollador: influent"
echo "   - Licencia: MIT"
echo
print_status "ğŸ’¡ CONSEJOS DE USO:"
echo "   - Navega por YouTube en el navegador embebido"
echo "   - Las URLs se detectan automÃ¡ticamente"
echo "   - Usa los botones del panel lateral para descargar"
echo "   - El historial se guarda automÃ¡ticamente"
echo
print_status "â³ Abriendo aplicaciÃ³n en 3 segundos..."
sleep 3

# Ejecutar la aplicaciÃ³n
print_status "ğŸ¬ Ejecutando aplicaciÃ³n..."
python3 yt-mediadownloader.py

# =============================================================================
# MANEJO DE SALIDA
# =============================================================================

if [ $? -ne 0 ]; then
    echo
    print_error "La aplicaciÃ³n se cerrÃ³ con errores"
    echo
    print_status "ğŸ” POSIBLES SOLUCIONES:"
    echo "   1. Verifica que todas las dependencias estÃ©n instaladas"
    echo "   2. AsegÃºrate de tener permisos de escritura en la carpeta"
    echo "   3. Verifica que no haya otros procesos usando los puertos necesarios"
    echo "   4. Revisa el archivo de logs si estÃ¡ disponible"
    echo
    print_status "ğŸ“ Para obtener ayuda, consulta:"
    echo "   - README.md del proyecto"
    echo "   - Issues en GitHub"
    echo "   - DocumentaciÃ³n oficial de PyQt5"
    echo
else
    echo
    print_success "La aplicaciÃ³n se cerrÃ³ correctamente"
    echo
fi

# =============================================================================
# FINALIZACIÃ“N
# =============================================================================

echo
print_header "============================================================================="
print_header "ğŸ‰ INSTALACIÃ“N COMPLETADA"
print_header "============================================================================="
echo
print_success "Python verificado: $PYTHON_VERSION"
print_success "Dependencias instaladas"
print_success "AplicaciÃ³n ejecutada"
echo
print_status "ğŸ’¡ Para ejecutar la aplicaciÃ³n nuevamente:"
echo "   python3 yt-mediadownloader.py"
echo
print_status "ğŸ“š Para mÃ¡s informaciÃ³n, consulta README.md"
print_status "ğŸŒ Repositorio: https://github.com/influent/yt-mediadownloader"
echo
print_header "============================================================================="
echo

# Pausa final para que el usuario pueda leer la informaciÃ³n
read -p "Presiona Enter para continuar..."
